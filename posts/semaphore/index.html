<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="信号量机制" /><meta name="author" content="katus" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="一、信号量概述" /><meta property="og:description" content="一、信号量概述" /><link rel="canonical" href="https://katus98.github.io/posts/semaphore/" /><meta property="og:url" content="https://katus98.github.io/posts/semaphore/" /><meta property="og:site_name" content="SUN Katus’ Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-16T00:54:08+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="信号量机制" /><meta name="twitter:site" content="@katus_SKR" /><meta name="twitter:creator" content="@katus" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"katus"},"dateModified":"2022-08-16T00:54:08+08:00","datePublished":"2022-08-16T00:54:08+08:00","description":"一、信号量概述","headline":"信号量机制","mainEntityOfPage":{"@type":"WebPage","@id":"https://katus98.github.io/posts/semaphore/"},"url":"https://katus98.github.io/posts/semaphore/"}</script><title>信号量机制 | SUN Katus' Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="SUN Katus' Blog"><meta name="application-name" content="SUN Katus' Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/favicons/apple-touch-icon.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">SUN Katus' Blog</a></div><div class="site-subtitle font-italic">幻想成为一位技术大神</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/katus98" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/katus_SKR" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sunkeran0818','outlook.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>信号量机制</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>信号量机制</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1660582448" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-08-16 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> SUN Katus </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4278 字"> <em>23 分钟</em>阅读</span></div></div></div><div class="post-content"><h2 id="一信号量概述"><span class="mr-2">一、信号量概述</span><a href="#一信号量概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="1概念"><span class="mr-2">1.概念</span><a href="#1概念" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>用户进程可以通过使用操作系统提供的一对原语来对信号量进行操作，从而很方便的实现了进程互斥、进程同步。</p><p>信号量其实就是一个变量（可以是一个整数，也可以是更复杂的记录型变量），可以用一个信号量来表示系统中某种资源的数量，比如：系统中只有一台打印机，就可以设置一个初值为1的信号量。</p><p>原语是一种特殊的程序段，其执行只能一气呵成，不可被中断。原语是由关中断和开中断指令实现的。</p><p>一对原语：<code class="language-plaintext highlighter-rouge">wait(S)</code>原语和<code class="language-plaintext highlighter-rouge">signal(S)</code>原语，可以把原语理解为我们自己写的函数，函数名分别为<code class="language-plaintext highlighter-rouge">wait</code>和<code class="language-plaintext highlighter-rouge">signal</code>，括号里的信号量<code class="language-plaintext highlighter-rouge">S</code>其实就是函数调用时传入的一个参数。<code class="language-plaintext highlighter-rouge">wait</code>、<code class="language-plaintext highlighter-rouge">signal</code>原语常简称为<code class="language-plaintext highlighter-rouge">P</code>、<code class="language-plaintext highlighter-rouge">V</code>操作（来自荷兰语<code class="language-plaintext highlighter-rouge">proberen</code>和<code class="language-plaintext highlighter-rouge">verhogen</code>）。因此，常把<code class="language-plaintext highlighter-rouge">wait(S)</code>、<code class="language-plaintext highlighter-rouge">signal(S)</code>两个操作分别写为<code class="language-plaintext highlighter-rouge">P(S)</code>、<code class="language-plaintext highlighter-rouge">V(S)</code>。</p><h3 id="2类别"><span class="mr-2">2.类别</span><a href="#2类别" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p>整型信号量</p><ul><li><p>用一个整型变量作为信号量，表示系统中某种资源的数量。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">S</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="c1">// 初始化信号量, 表示某种资源的剩余数</span>
<span class="c1">// 注意wait与signal都是通过原语实现的, 是原子性的, 这里仅仅是通过C语言模拟</span>
<span class="kt">void</span> <span class="nf">wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">S</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>   <span class="c1">// 如果不满足需求, 则忙等待</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// 注意wait与signal都是通过原语实现的, 是原子性的, 这里仅仅是通过C语言模拟</span>
<span class="kt">void</span> <span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">S</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>进程调用逻辑。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">wait</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>   <span class="c1">// P操作</span>
<span class="n">useResource</span><span class="p">();</span>   <span class="c1">// 使用临界资源</span>
<span class="n">signal</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>   <span class="c1">// V操作</span>
</pre></table></code></div></div><li><p>由于只有单一的整型信号量，只能通过忙等待阻塞进程，不满足“让权等待”的原则。</p></ul><li><p>记录型信号量</p><ul><li><p>整型信号量存在“忙等”问题，因此人们又提出了“记录型信号量”，即用记录型数据结构表示的信号量。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">Struct</span> <span class="n">process</span> <span class="o">*</span><span class="n">L</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Semaphore</span><span class="p">;</span>
<span class="c1">// 注意wait与signal都是通过原语实现的, 是原子性的, 这里仅仅是通过C语言模拟</span>
<span class="kt">void</span> <span class="nf">wait</span><span class="p">(</span><span class="n">Semaphore</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">S</span><span class="p">.</span><span class="n">value</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// 无法获取到资源</span>
        <span class="n">block</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">L</span><span class="p">);</span>   <span class="c1">// 进程调用block原语进行自我阻塞</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// 注意wait与signal都是通过原语实现的, 是原子性的, 这里仅仅是通过C语言模拟</span>
<span class="kt">void</span> <span class="nf">signal</span><span class="p">(</span><span class="n">Semaphore</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">S</span><span class="p">.</span><span class="n">value</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// 如果当前进程释放资源之后value仍不大于0, 说明有其他进程在排队</span>
        <span class="n">wakeup</span><span class="p">(</span><span class="n">S</span><span class="p">.</span><span class="n">L</span><span class="p">);</span>   <span class="c1">// 调用wakeup原语唤醒等待队列中的第一个进程</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li><p>可以解决让权等待的问题；可以实现进程互斥和进程同步。</p></ul></ul><h2 id="二信号量机制实现进程互斥同步与前驱"><span class="mr-2">二、信号量机制实现进程互斥、同步与前驱</span><a href="#二信号量机制实现进程互斥同步与前驱" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="1进程互斥"><span class="mr-2">1.进程互斥</span><a href="#1进程互斥" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>进程互斥可以通过<code class="language-plaintext highlighter-rouge">mutex</code>信号量的<code class="language-plaintext highlighter-rouge">P</code>、<code class="language-plaintext highlighter-rouge">V</code>操作将临界区包裹来实现。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">Semaphore</span> <span class="n">mutex</span> <span class="o">=</span> <span class="n">new</span> <span class="nf">Semaphore</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">process</span> <span class="p">{</span>
    <span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
    <span class="n">criticalArea</span><span class="p">();</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="2进程同步"><span class="mr-2">2.进程同步</span><a href="#2进程同步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>信号量初始化为0，需要先执行的进程代码执行完之后执行信号量<code class="language-plaintext highlighter-rouge">V</code>操作，后执行进程代码执行之前调用信号量<code class="language-plaintext highlighter-rouge">P</code>操作。</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">Semaphore</span> <span class="n">s</span> <span class="o">=</span> <span class="n">new</span> <span class="nf">Semaphore</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">processA</span> <span class="p">{</span>
    <span class="c1">// 进程A临界区先执行</span>
    <span class="n">criticalAreaA</span><span class="p">();</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">processB</span> <span class="p">{</span>
    <span class="n">wait</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="c1">// 进程B临界区后执行</span>
    <span class="n">criticalAreaB</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="3进程前驱"><span class="mr-2">3.进程前驱</span><a href="#3进程前驱" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>实际上是多个进程形成有向无环图，产生一个具有先后关系多进程同步情况。可以为每一对前驱关系都按照进程同步的方式设计一个信号量。</p><h2 id="三信号量机制解决经典进程问题"><span class="mr-2">三、信号量机制解决经典进程问题</span><a href="#三信号量机制解决经典进程问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>以下例子均通过Java多线程的方式模拟多进程</p></blockquote><h3 id="1单生产者-消费者问题"><span class="mr-2">1.单生产者-消费者问题</span><a href="#1单生产者-消费者问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>有一类生产者生产一种产品，一类消费者消费同一种产品。生产者将生产的产品放入一个有限缓冲区，消费者从这个缓冲区内取走产品消费。现在需要保证各方对缓冲区的操作是互斥的，同时缓冲区满了则暂停生产，缓冲区空了则暂停消费。</p><p>解法：增删缓冲区的操作作为临界区互斥，同时将缓冲区空位的个数和产品的个数都作为资源信号量引导进程同步。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.katus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Semaphore</span><span class="o">;</span>

<span class="cm">/**
 * 通过信号量机制实现的单生产者-消费者模型
 *
 * @author SUN Katus
 * @version 1.0, 2022-08-12
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingleProducerConsumer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CAPACITY</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="no">BOUND</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Random</span> <span class="n">random</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Buffer</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">mutex</span><span class="o">,</span> <span class="n">full</span><span class="o">,</span> <span class="n">empty</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SingleProducerConsumer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Buffer</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">full</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">empty</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="no">CAPACITY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">product</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="no">BOUND</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="c1">// 互斥操作必须在同步操作之后, 否则会死锁 (保证只有满足了同步关系才允许访问临界资源)</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Produced a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">full</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="n">full</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="kt">int</span> <span class="n">product</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Consumed a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Buffer</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Buffer</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="no">CAPACITY</span><span class="o">];</span>
            <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFull</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">index</span> <span class="o">==</span> <span class="no">CAPACITY</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">buffer</span><span class="o">[</span><span class="n">index</span><span class="o">++]</span> <span class="o">=</span> <span class="n">product</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">buffer</span><span class="o">[--</span><span class="n">index</span><span class="o">];</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SingleProducerConsumer</span> <span class="n">singleProducerConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SingleProducerConsumer</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">singleProducerConsumer</span><span class="o">.</span><span class="na">new</span> <span class="nf">Consumer</span><span class="o">(),</span> <span class="s">"Consumer"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">singleProducerConsumer</span><span class="o">.</span><span class="na">new</span> <span class="nf">Producer</span><span class="o">(),</span> <span class="s">"Producer"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="2多生产者-消费者问题"><span class="mr-2">2.多生产者-消费者问题</span><a href="#2多生产者-消费者问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>多类生产者消费者生产、消费不同的产品，但是共享同一个有限缓冲区。现在需要保证各方对缓冲区的操作是互斥的，同时能够满足各类生产者消费者正常生产消费。</p><p>解法：增删缓冲区的操作作为临界区互斥，同时将缓冲区空位的个数和各类产品的个数都作为资源信号量引导进程同步。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.katus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.ToString</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Semaphore</span><span class="o">;</span>

<span class="cm">/**
 * 通过信号量机制实现的多类别生产者-消费者模型
 *
 * @author SUN Katus
 * @version 1.0, 2022-08-12
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiProducerConsumer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CAPACITY</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="no">BOUND</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Buffer</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">mutex</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">empty</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MultiProducerConsumer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Buffer</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">empty</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="no">CAPACITY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProducerA</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProductA</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="no">BOUND</span><span class="o">;</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Produced a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">a</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProducerB</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProductB</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="no">BOUND</span><span class="o">;</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Produced a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">b</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsumerA</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="n">a</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readByType</span><span class="o">(</span><span class="s">"A"</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Consumed a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsumerB</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="n">b</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readByType</span><span class="o">(</span><span class="s">"B"</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Consumed a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Buffer</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">set</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Buffer</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">Product</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">readByType</span><span class="o">(</span><span class="nc">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Product</span> <span class="n">product</span> <span class="o">:</span> <span class="n">set</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">productName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">set</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">product</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@ToString</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ProductA</span> <span class="kd">extends</span> <span class="nc">Product</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ProductA</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"A"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@ToString</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ProductB</span> <span class="kd">extends</span> <span class="nc">Product</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ProductB</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"B"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MultiProducerConsumer</span> <span class="n">multiProducerConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MultiProducerConsumer</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">multiProducerConsumer</span><span class="o">.</span><span class="na">new</span> <span class="nf">ProducerA</span><span class="o">(),</span> <span class="s">"ProducerA"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">multiProducerConsumer</span><span class="o">.</span><span class="na">new</span> <span class="nf">ProducerB</span><span class="o">(),</span> <span class="s">"ProducerB"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">multiProducerConsumer</span><span class="o">.</span><span class="na">new</span> <span class="nf">ConsumerA</span><span class="o">(),</span> <span class="s">"ConsumerA"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">multiProducerConsumer</span><span class="o">.</span><span class="na">new</span> <span class="nf">ConsumerB</span><span class="o">(),</span> <span class="s">"ConsumerB"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="3吸烟者问题"><span class="mr-2">3.吸烟者问题</span><a href="#3吸烟者问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>一类生产者（提供者）生产多种产品，多类消费者（吸烟者）消费各自的产品类型，使用同一个共享缓冲区。需要保证各方对缓冲区的操作是互斥的，同时能够满足生产者和各类消费者正常生产消费。</p><p>解法：增删缓冲区的操作作为临界区互斥，同时将缓冲区空位的个数和各类产品的个数都作为资源信号量引导进程同步。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.katus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.ToString</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Semaphore</span><span class="o">;</span>

<span class="cm">/**
 * 通过信号量解决吸烟者问题(单生产者生产多种产品, 多种消费者消费不同的产品)
 *
 * @author SUN Katus
 * @version 1.0, 2022-08-12
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProviderSmoker</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CAPACITY</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="no">BOUND</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Buffer</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">mutex</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">empty</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ProviderSmoker</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Buffer</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">empty</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="no">CAPACITY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Provider</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Random</span> <span class="n">random</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Provider</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
                    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                    <span class="nc">Product</span> <span class="n">product</span><span class="o">;</span>
                    <span class="k">switch</span> <span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
                            <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProductA</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                            <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProductB</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">default</span><span class="o">:</span>
                            <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProductC</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="no">BOUND</span><span class="o">;</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Provide a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="k">switch</span> <span class="o">(</span><span class="n">r</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
                            <span class="n">a</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                            <span class="n">b</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">default</span><span class="o">:</span>
                            <span class="n">c</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmokerA</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="n">a</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readByType</span><span class="o">(</span><span class="s">"A"</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Smoke a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmokerB</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="n">b</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readByType</span><span class="o">(</span><span class="s">"B"</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Smoke a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SmokerC</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="n">c</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readByType</span><span class="o">(</span><span class="s">"C"</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Smoke a product: {}"</span><span class="o">,</span> <span class="n">product</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">empty</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Buffer</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">set</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Buffer</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">Product</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Product</span> <span class="nf">readByType</span><span class="o">(</span><span class="nc">String</span> <span class="n">productName</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Product</span> <span class="n">product</span> <span class="o">:</span> <span class="n">set</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">productName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">set</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">product</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@ToString</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ProductA</span> <span class="kd">extends</span> <span class="nc">Product</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ProductA</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"A"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@ToString</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ProductB</span> <span class="kd">extends</span> <span class="nc">Product</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ProductB</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"B"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@ToString</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ProductC</span> <span class="kd">extends</span> <span class="nc">Product</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ProductC</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"C"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ProviderSmoker</span> <span class="n">providerSmoker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProviderSmoker</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">providerSmoker</span><span class="o">.</span><span class="na">new</span> <span class="nf">Provider</span><span class="o">(),</span> <span class="s">"Provider"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">providerSmoker</span><span class="o">.</span><span class="na">new</span> <span class="nf">SmokerA</span><span class="o">(),</span> <span class="s">"SmokerA"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">providerSmoker</span><span class="o">.</span><span class="na">new</span> <span class="nf">SmokerB</span><span class="o">(),</span> <span class="s">"SmokerB"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">providerSmoker</span><span class="o">.</span><span class="na">new</span> <span class="nf">SmokerC</span><span class="o">(),</span> <span class="s">"SmokerC"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="4读者-写者问题"><span class="mr-2">4.读者-写者问题</span><a href="#4读者-写者问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>多个读写进程对同一文件资源进行读写，需要保证读进程之间可以并发执行，而写进程只能单独执行。</p><p>解法：通过一个整型变量记录当前有多少个读进程正在读，一个互斥信号量保证对前述整型变量的操作是原子性的；一个读写信号量表示读写资源只能被各种读进程或者一个写进程占用，一个写信号量保证写进程不会饿死。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.katus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.Semaphore</span><span class="o">;</span>

<span class="cm">/**
 * 用信号量解决读者-写者问题
 *
 * @author SUN Katus
 * @version 1.0, 2022-08-12
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReaderWriter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">BOUND</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>
    <span class="cm">/**
     * 保证记录读进程数量的操作互斥(保证对readCount的操作是原子化的, 当然也可以使用原子类)
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">mutex</span><span class="o">;</span>
    <span class="cm">/**
     * 保证写进程和其他进程之间的互斥关系
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">rw</span><span class="o">;</span>
    <span class="cm">/**
     * 保证写进程不会饿死
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">w</span><span class="o">;</span>
    <span class="cm">/**
     * 读进程正在读的数量
     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">readCount</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReaderWriter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">w</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">readCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Reader</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">readCount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">rw</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">readCount</span><span class="o">++;</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Reading {} ..."</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="no">BOUND</span><span class="o">;</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">readCount</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">rw</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">readCount</span><span class="o">--;</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Writer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">rw</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Writing {} ..."</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="no">BOUND</span><span class="o">;</span>
                    <span class="n">rw</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ReaderWriter</span> <span class="n">readerWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReaderWriter</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">readerWriter</span><span class="o">.</span><span class="na">new</span> <span class="nf">Reader</span><span class="o">(),</span> <span class="s">"Reader"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">readerWriter</span><span class="o">.</span><span class="na">new</span> <span class="nf">Writer</span><span class="o">(),</span> <span class="s">"Writer"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="5哲学家进餐问题"><span class="mr-2">5.哲学家进餐问题</span><a href="#5哲学家进餐问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>五个哲学家围着一个圆桌吃饭，总计五支筷子，分别放在每个哲学家之间。每个哲学家只能思考或者吃饭，吃饭需要同时拿取左右两边的筷子。</p><p>解法：规定哲学家获取筷子的顺序，比如要求偶数号哲学家先拿左筷子，而奇数号哲学家先拿右筷子。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.katus</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.ToString</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Semaphore</span><span class="o">;</span>

<span class="cm">/**
 * 用信号量解决哲学家进餐问题 (预防死锁)
 * * 策略1 总计N个哲学家, 最多只允许N-1个哲学家同时吃饭
 * * 策略2 要求偶数编号哲学家和奇数编号哲学家拿筷子的顺序相反 (本实现)
 * * 策略3 将哲学家拿筷子的过程互斥
 *
 * @author SUN Katus
 * @version 1.0, 2022-08-12
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhilosopherMeal</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CAPACITY</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span><span class="o">[]</span> <span class="n">chopsticks</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Random</span> <span class="n">random</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PhilosopherMeal</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">chopsticks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">[</span><span class="no">CAPACITY</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">CAPACITY</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">chopsticks</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@ToString</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Philosopher</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Philosopher</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">meal</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextBoolean</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">meal</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">int</span> <span class="n">rightId</span> <span class="o">=</span> <span class="o">(</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="no">CAPACITY</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">id</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">chopsticks</span><span class="o">[</span><span class="n">id</span><span class="o">].</span><span class="na">acquire</span><span class="o">();</span>
                            <span class="n">chopsticks</span><span class="o">[</span><span class="n">rightId</span><span class="o">].</span><span class="na">acquire</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">chopsticks</span><span class="o">[</span><span class="n">rightId</span><span class="o">].</span><span class="na">acquire</span><span class="o">();</span>
                            <span class="n">chopsticks</span><span class="o">[</span><span class="n">id</span><span class="o">].</span><span class="na">acquire</span><span class="o">();</span>
                        <span class="o">}</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"{} is eating..."</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
                        <span class="n">chopsticks</span><span class="o">[</span><span class="n">id</span><span class="o">].</span><span class="na">release</span><span class="o">();</span>
                        <span class="n">chopsticks</span><span class="o">[</span><span class="n">rightId</span><span class="o">].</span><span class="na">release</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"{} is thinking..."</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">PhilosopherMeal</span> <span class="n">philosopherMeal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PhilosopherMeal</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">CAPACITY</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">philosopherMeal</span><span class="o">.</span><span class="na">new</span> <span class="nf">Philosopher</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="s">"Philosopher-"</span> <span class="o">+</span> <span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/operating-system/'>Operating System</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/operating-system/" class="post-tag no-text-decoration" >Operating System</a> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a> <a href="/tags/multiprocessing/" class="post-tag no-text-decoration" >Multiprocessing</a> <a href="/tags/multithreading/" class="post-tag no-text-decoration" >Multithreading</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6+-+SUN+Katus%27+Blog&url=https%3A%2F%2Fkatus98.github.io%2Fposts%2Fsemaphore%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6+-+SUN+Katus%27+Blog&u=https%3A%2F%2Fkatus98.github.io%2Fposts%2Fsemaphore%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fkatus98.github.io%2Fposts%2Fsemaphore%2F&text=%E4%BF%A1%E5%8F%B7%E9%87%8F%E6%9C%BA%E5%88%B6+-+SUN+Katus%27+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/mybatis-spring-scanner/">Mybatis的Spring插件扫描原理</a><li><a href="/posts/java-thread/">Java开发技术之多线程</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/multithreading/">Multithreading</a> <a class="post-tag" href="/tags/computer-network/">Computer Network</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/multiprocessing/">Multiprocessing</a> <a class="post-tag" href="/tags/mybatis/">Mybatis</a> <a class="post-tag" href="/tags/operating-system/">Operating System</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/java-thread/"><div class="card-body"> <em class="small" data-ts="1597405997" data-df="YYYY-MM-DD" > 2020-08-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Java开发技术之多线程</h3><div class="text-muted small"><p> 暑假期间，个人对一些未来研究生阶段可能会常用的编程技术进行重新一轮的系统复习和学习，及希望能够查缺补漏，有所提升。本文也是作为复习和学习过程中的笔记，用于长久的记录。不排除其中可能含有部分疏漏和错误，如有发现，希望各位能够批评指正，谢谢。 一、多线程概述 （一）概述 每个进程有独立的方法区、堆空间、虚拟机栈和程序计数器。 一个进程可能拥有多个线程。 每个线程有独立...</p></div></div></a></div><div class="card"> <a href="/posts/java-adv/"><div class="card-body"> <em class="small" data-ts="1597237687" data-df="YYYY-MM-DD" > 2020-08-12 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Java基础开发技术查缺补漏笔记</h3><div class="text-muted small"><p> 暑假期间，个人对一些未来研究生阶段可能会常用的编程技术进行重新一轮的系统复习和学习，及希望能够查缺补漏，有所提升。本文也是作为复习和学习过程中的笔记，用于长久的记录。不排除其中可能含有部分疏漏和错误，如有发现，希望各位能够批评指正，谢谢。 一、准备工作 JDK版本：1.8.0_261（Java HotSpot TM） （一）Java 文档注释 /** * @auth...</p></div></div></a></div><div class="card"> <a href="/posts/mybatis-spring-scanner/"><div class="card-body"> <em class="small" data-ts="1662952577" data-df="YYYY-MM-DD" > 2022-09-12 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mybatis的Spring插件扫描原理</h3><div class="text-muted small"><p> 本文主要针对Mybatis的Spring插件的扫描进行分析，从MapperScan注解切入，进行源码层面的简要解读。 一、@MapperScan注解 @MapperScan是Mybatis的Spring插件的核心扫描配置，其通过Spring配置的@Import注解注册其核心配置。 1 2 3 4 5 6 7 8 9 10 package org.myba...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/linux-multi-gateway-config/" class="btn btn-outline-primary" prompt="上一篇"><p>Linux服务器多网卡多网关配置解决方案</p></a> <a href="/posts/mybatis-spring-scanner/" class="btn btn-outline-primary" prompt="下一篇"><p>Mybatis的Spring插件扫描原理</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/katus_SKR">SUN Katus</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/multithreading/">Multithreading</a> <a class="post-tag" href="/tags/computer-network/">Computer Network</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/multiprocessing/">Multiprocessing</a> <a class="post-tag" href="/tags/mybatis/">Mybatis</a> <a class="post-tag" href="/tags/operating-system/">Operating System</a> <a class="post-tag" href="/tags/spring/">Spring</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">发现新版本的内容。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
